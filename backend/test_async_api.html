<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¹„ë™ê¸° AI ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸ (ë©´ì ‘ ì§ˆë¬¸ + í•™ìŠµ ê²½ë¡œ)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }

        .status.pending {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }

        .status.progress {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
        }

        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .result {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }

        .question {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
        }

        input {
            width: 300px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <h1>ğŸš€ ë¹„ë™ê¸° AI ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸</h1>
    <p style="text-align: center; color: #666; margin-bottom: 30px;">
        ë©´ì ‘ ì§ˆë¬¸ ìƒì„± & í•™ìŠµ ê²½ë¡œ ì¶”ì²œ ì„œë¹„ìŠ¤ í†µí•© í…ŒìŠ¤íŠ¸
    </p>

    <div class="container">
        <h3>ğŸ“‹ í…ŒìŠ¤íŠ¸ ì„¤ì •</h3>

        <div style="margin-bottom: 15px;">
            <strong>ì„œë¹„ìŠ¤ ì„ íƒ:</strong><br>
            <label style="margin-right: 20px;">
                <input type="radio" name="serviceType" value="interview" checked>
                ğŸ¯ ë©´ì ‘ ì§ˆë¬¸ ìƒì„±
            </label>
            <label>
                <input type="radio" name="serviceType" value="learning">
                ğŸ“š í•™ìŠµ ê²½ë¡œ ì¶”ì²œ
            </label>
        </div>

        <label>
            ì´ë ¥ì„œ ê³ ìœ  í‚¤:
            <input type="text" id="resumeKey" value="ìœ¤ì •ì€_2" placeholder="ì˜ˆ: ìœ¤ì •ì€_2">
        </label>
        <br><br>

        <button onclick="startAsyncGeneration()" id="startBtn">ë¹„ë™ê¸° ì‘ì—… ì‹œì‘</button>
        <button onclick="checkProgress()" id="checkBtn" disabled>ì§„í–‰ ìƒí™© í™•ì¸</button>
        <button onclick="startSSEStream()" id="sseBtn" disabled>SSE ìŠ¤íŠ¸ë¦¼ ì‹œì‘</button>

        <div id="serviceInfo"
            style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 4px; font-size: 14px;">
            <span id="serviceDescription">ğŸ¯ ë©´ì ‘ ì§ˆë¬¸ ìƒì„± ì„œë¹„ìŠ¤ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤</span>
        </div>
    </div>

    <div class="container">
        <h3>ğŸ“Š ì§„í–‰ ìƒí™©</h3>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div id="progressText">ì§„í–‰ë¥ : 0%</div>

        <div id="statusContainer">
            <div class="status pending" id="status">
                ì‘ì—…ì„ ì‹œì‘í•˜ë ¤ë©´ ìœ„ì˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
            </div>
        </div>
    </div>

    <div class="container">
        <h3>ğŸ“¡ ì‹¤ì‹œê°„ ë¡œê·¸</h3>
        <div id="logContainer"
            style="height: 200px; overflow-y: auto; background: #000; color: #0f0; padding: 10px; font-family: monospace; border-radius: 4px;">
            ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ. ì‘ì—…ì„ ì‹œì‘í•˜ì„¸ìš”...<br>
        </div>
    </div>

    <div id="resultContainer" style="display: none;">
        <div class="container">
            <h3 id="resultTitle">âœ… ê²°ê³¼</h3>
            <div id="resultContent" class="result"></div>
        </div>
    </div>

    <script>
        let currentTaskId = null;
        let eventSource = null;
        let currentServiceType = 'interview';

        // ì„œë¹„ìŠ¤ íƒ€ì… ê°€ì ¸ì˜¤ê¸°
        function getServiceType() {
            const radios = document.getElementsByName('serviceType');
            for (const radio of radios) {
                if (radio.checked) {
                    return radio.value;
                }
            }
            return 'interview';
        }

        // ì„œë¹„ìŠ¤ API ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        function getServiceConfig(serviceType) {
            if (serviceType === 'interview') {
                return {
                    endpoint: 'interview',
                    path: 'questions',
                    description: 'ğŸ¯ ë©´ì ‘ ì§ˆë¬¸ ìƒì„± ì„œë¹„ìŠ¤ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤',
                    resultTitle: 'âœ… ìƒì„±ëœ ë©´ì ‘ ì§ˆë¬¸'
                };
            } else {
                return {
                    endpoint: 'learning',
                    path: 'learning-path',
                    description: 'ğŸ“š í•™ìŠµ ê²½ë¡œ ì¶”ì²œ ì„œë¹„ìŠ¤ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤',
                    resultTitle: 'âœ… ìƒì„±ëœ í•™ìŠµ ê²½ë¡œ'
                };
            }
        }

        // ì„œë¹„ìŠ¤ ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸
        function updateServiceUI() {
            const serviceType = getServiceType();
            const config = getServiceConfig(serviceType);

            currentServiceType = serviceType;
            document.getElementById('serviceDescription').textContent = config.description;
            document.getElementById('resultTitle').textContent = config.resultTitle;

            // ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì´ ìˆë‹¤ë©´ ì´ˆê¸°í™”
            if (currentTaskId) {
                currentTaskId = null;
                document.getElementById('checkBtn').disabled = true;
                document.getElementById('sseBtn').disabled = true;
                document.getElementById('resultContainer').style.display = 'none';
                updateProgress(0, 'ì„œë¹„ìŠ¤ë¥¼ ë³€ê²½í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ì‘ì—…ì„ ì‹œì‘í•˜ì„¸ìš”.', 'pending');
            }
        }

        // ë¼ë””ì˜¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('DOMContentLoaded', function () {
            const radios = document.getElementsByName('serviceType');
            radios.forEach(radio => {
                radio.addEventListener('change', updateServiceUI);
            });
        });

        function log(message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            logContainer.innerHTML += `[${timestamp}] ${message}<br>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateProgress(progress, message, stage) {
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `ì§„í–‰ë¥ : ${progress}% - ${message}`;

            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${stage}`;
        }

        async function startAsyncGeneration() {
            const resumeKey = document.getElementById('resumeKey').value;
            if (!resumeKey) {
                alert('ì´ë ¥ì„œ ê³ ìœ  í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const serviceType = getServiceType();
            const config = getServiceConfig(serviceType);

            try {
                log(`${config.description.split(' ')[0]} ë¹„ë™ê¸° ì‘ì—… ì‹œì‘: ${resumeKey}`);
                updateProgress(0, 'ì‘ì—… ì‹œì‘ ì¤‘...', 'pending');

                const apiUrl = `http://api.localhost/api/v1/${config.endpoint}/async/${resumeKey}/${config.path}`;
                log(`ğŸ“¡ API í˜¸ì¶œ: ${apiUrl}`);

                const response = await fetch(apiUrl, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                currentTaskId = data.task_id;
                currentServiceType = serviceType;

                log(`âœ… ì‘ì—… ID: ${currentTaskId}`);
                log(`ğŸ“‹ ì„œë¹„ìŠ¤: ${serviceType === 'interview' ? 'ë©´ì ‘ ì§ˆë¬¸ ìƒì„±' : 'í•™ìŠµ ê²½ë¡œ ì¶”ì²œ'}`);
                log(`â° ì˜ˆìƒ ì™„ë£Œ ì‹œê°„: ${data.estimated_time}`);

                document.getElementById('checkBtn').disabled = false;
                document.getElementById('sseBtn').disabled = false;

                updateProgress(5, data.message, 'pending');

            } catch (error) {
                log(`âŒ ì˜¤ë¥˜: ${error.message}`);
                updateProgress(0, `ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        async function checkProgress() {
            if (!currentTaskId) {
                alert('ë¨¼ì € ì‘ì—…ì„ ì‹œì‘í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const config = getServiceConfig(currentServiceType);
                const response = await fetch(`http://api.localhost/api/v1/${config.endpoint}/tasks/${currentTaskId}/progress`);
                const data = await response.json();

                log(`ğŸ“Š ìƒíƒœ: ${data.state}, ì§„í–‰ë¥ : ${data.progress}%`);
                updateProgress(data.progress, data.message, data.stage);

                if (data.state === 'SUCCESS') {
                    showResult(data.result, currentServiceType);
                } else if (data.state === 'FAILURE') {
                    log(`âŒ ì‘ì—… ì‹¤íŒ¨: ${data.error}`);
                }

            } catch (error) {
                log(`âŒ ì§„í–‰ ìƒí™© ì¡°íšŒ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        function startSSEStream() {
            if (!currentTaskId) {
                alert('ë¨¼ì € ì‘ì—…ì„ ì‹œì‘í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (eventSource) {
                eventSource.close();
            }

            const config = getServiceConfig(currentServiceType);
            const streamUrl = `http://api.localhost/api/v1/${config.endpoint}/tasks/${currentTaskId}/stream`;

            log(`ğŸŒŠ SSE ìŠ¤íŠ¸ë¦¼ ì‹œì‘: ${currentTaskId}`);
            log(`ğŸ“¡ ìŠ¤íŠ¸ë¦¼ URL: ${streamUrl}`);

            eventSource = new EventSource(streamUrl);

            eventSource.addEventListener('progress', (event) => {
                const data = JSON.parse(event.data);
                log(`ğŸ“ˆ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸: ${data.progress}% - ${data.message}`);
                updateProgress(data.progress, data.message, data.stage);
            });

            eventSource.addEventListener('completed', (event) => {
                const data = JSON.parse(event.data);
                log(`ğŸ‰ ì‘ì—… ì™„ë£Œ!`);
                updateProgress(100, data.message, 'success');
                showResult(data.result, currentServiceType);
                eventSource.close();
            });

            eventSource.addEventListener('error', (event) => {
                const data = JSON.parse(event.data);
                log(`âŒ ìŠ¤íŠ¸ë¦¼ ì˜¤ë¥˜: ${data.error || data.message}`);
                updateProgress(0, `ì˜¤ë¥˜: ${data.error || data.message}`, 'error');
                eventSource.close();
            });

            eventSource.addEventListener('close', (event) => {
                log(`ğŸ”š ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ`);
                eventSource.close();
            });

            eventSource.onerror = (error) => {
                log(`âŒ SSE ì—°ê²° ì˜¤ë¥˜`);
                eventSource.close();
            };
        }

        function showResult(result, serviceType) {
            const resultContainer = document.getElementById('resultContainer');
            const resultContent = document.getElementById('resultContent');

            let html = `
                <h4>ğŸ“‹ ìƒì„± ì •ë³´</h4>
                <p><strong>ì´ë ¥ì„œ ID:</strong> ${result.resume_id || result.unique_key}</p>
                <p><strong>ìƒì„± ì‹œê°„:</strong> ${result.generated_at}</p>
            `;

            if (serviceType === 'interview') {
                html += `
                    <p><strong>ì‚¬ìš© ëª¨ë¸:</strong> ${result.model_used}</p>
                    <p><strong>ì‘ì—… ID:</strong> ${result.task_id}</p>
                    
                    <h4>â“ ë©´ì ‘ ì§ˆë¬¸ë“¤</h4>
                `;

                result.questions.forEach((question, index) => {
                    html += `
                        <div class="question">
                            <h5>ì§ˆë¬¸ ${index + 1} - ${question.difficulty} (${question.topic})</h5>
                            <p><strong>ì§ˆë¬¸:</strong> ${question.question}</p>
                            <p><strong>ì¢‹ì€ ë‹µë³€ì´ í¬í•¨í•´ì•¼ í•  ë‚´ìš©:</strong> ${question.what_good_answers_cover}</p>
                        </div>
                    `;
                });

            } else if (serviceType === 'learning') {
                html += `
                    <p><strong>ì‚¬ìš© ëª¨ë¸:</strong> ${result.model}</p>
                    <p><strong>ì œê³µì:</strong> ${result.provider}</p>
                    
                    <h4>ğŸ¯ ì´ë ¥ì„œ ë¶„ì„</h4>
                    <div class="question">
                        <h5>ğŸ’ª ê°•ì </h5>
                        <ul>
                `;

                result.analysis.strengths.forEach(strength => {
                    html += `<li>${strength}</li>`;
                });

                html += `
                        </ul>
                        <h5>ğŸ“ˆ ê°œì„  ì˜ì—­</h5>
                        <ul>
                `;

                result.analysis.weaknesses.forEach(weakness => {
                    html += `<li>${weakness}</li>`;
                });

                html += `
                        </ul>
                    </div>
                    
                    <h4>ğŸ“š ë§ì¶¤ í•™ìŠµ ê²½ë¡œ</h4>
                    <div class="question">
                        <h5>ğŸ“ ì „ì²´ ìš”ì•½</h5>
                        <p>${result.summary}</p>
                    </div>
                `;

                result.learning_paths.forEach((path, index) => {
                    const typeIcon = path.type === 'strength' ? 'ğŸ’ª' : 'ğŸ“ˆ';
                    const typeText = path.type === 'strength' ? 'ê°•ì  ì‹¬í™”' : 'ì•½ì  ë³´ì™„';

                    html += `
                        <div class="question">
                            <h5>${typeIcon} í•™ìŠµ ${index + 1}: ${path.title} (${typeText})</h5>
                            <p><strong>ì„¤ëª…:</strong> ${path.description}</p>
                            <p><strong>ì¶”ì²œ ì´ìœ :</strong> ${path.reason}</p>
                            <p><strong>í•™ìŠµ ë¦¬ì†ŒìŠ¤:</strong> ${path.resources.join(', ')}</p>
                            <p><strong>ì°¸ê³  ë§í¬:</strong> <a href="${path.link}" target="_blank">${path.link}</a></p>
                        </div>
                    `;
                });
            }

            resultContent.innerHTML = html;
            resultContainer.style.display = 'block';

            // ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            resultContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ EventSource ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>

</html>